name: Yocto Librelp

# START OF COMMON SECTION
on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
# END OF COMMON SECTION

jobs:
  build_wolfprovider:
    uses: ./.github/workflows/build-wolfprovider.yml
    with:
      wolfssl_ref: ${{ matrix.wolfssl_ref }}
      openssl_ref: ${{ matrix.openssl_ref }}
      fips_ref: ${{ matrix.fips_ref }}
      replace_default: ${{ matrix.replace_default }}
      build_type: 'yocto'
    strategy:
      matrix:
        wolfssl_ref: [ 'v5.8.4-stable' ]
        openssl_ref: [ 'openssl-3.2.6' ]
        fips_ref: [ 'FIPS' ]
        replace_default: [ true, false ]

  verify_yocto_env:
    needs: build_wolfprovider
    uses: ./.github/workflows/yocto-verify.yml
    with:
      wolfssl_ref: ${{ matrix.wolfssl_ref }}
      openssl_ref: ${{ matrix.openssl_ref }}
      fips_ref: ${{ matrix.fips_ref }}
      replace_default: ${{ matrix.replace_default }}
    strategy:
      fail-fast: false
      matrix:
        wolfssl_ref: [ 'v5.8.4-stable' ]
        openssl_ref: [ 'openssl-3.2.6' ]
        fips_ref: [ 'FIPS' ]
        replace_default: [ true, false ]

  run_librelp_ptest:
    name: Run Librelp Ptest - ${{ matrix.wolfssl_ref }}-${{ matrix.openssl_ref }}-${{ matrix.fips_ref }}-${{ matrix.replace_default }}
    needs: [build_wolfprovider, verify_yocto_env]
    strategy:
      fail-fast: false
      matrix:
        wolfssl_ref: [ 'v5.8.4-stable' ]
        openssl_ref: [ 'openssl-3.2.6' ]
        fips_ref: [ 'FIPS' ]
        replace_default: [ true, false ]
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/crops/poky:ubuntu-22.04
      options: --user root
    timeout-minutes: 60

    steps:
      - name: Checkout wolfProvider
        uses: actions/checkout@v4

      - name: Download WIC images
        uses: actions/download-artifact@v4
        with:
          name: yocto-image-${{ matrix.fips_ref == 'FIPS' && 'fips' || 'nonfips' }}-${{ matrix.replace_default && 'replace-default' || 'standalone' }}
          path: /tmp/yocto-images

      - name: Install QEMU, expect, and xz-utils
        run: |
          apt-get update
          apt-get install -y qemu-system-x86 expect xz-utils

      - name: Setup WIC image
        run: |
          cd /tmp/yocto-images
          if ls *.wic.xz 1> /dev/null 2>&1; then
            unxz -v *.wic.xz || true
          fi
          WIC_FILE=$(ls *.wic 2>/dev/null | grep -v "\.wic\." | head -1)
          if [ -z "$WIC_FILE" ] || [ ! -f "$WIC_FILE" ]; then
            echo "ERROR: No decompressed WIC file found"
            exit 1
          fi
          echo "WIC_PATH=/tmp/yocto-images/$WIC_FILE" >> $GITHUB_ENV

      - name: Run librelp ptest
        timeout-minutes: 60
        run: |
          echo "=== Running librelp ptest for ${{ matrix.fips_ref }}-${{ matrix.replace_default }} ==="
          OUTPUT_FILE="/tmp/librelp-ptest-output-${{ matrix.fips_ref }}-${{ matrix.replace_default }}.txt"
          
          export EXPECT_TIMEOUT=3600 # 1 hour
          $GITHUB_WORKSPACE/.github/scripts/boot-qemu.sh \
            "$WIC_PATH" \
            "echo 'setting up environment'" \
            "wolfproviderenv" \
            "echo '=== Running librelp ptest ==='" \
            "cd /usr/lib/librelp/ptest && ./run-ptest" > "$OUTPUT_FILE" 2>&1 || true
          
          echo "=== Librelp ptest output ==="
          cat "$OUTPUT_FILE"
          echo ""
          
          # Verify ptest results
          echo "=== Verifying librelp ptest results ==="
          source $GITHUB_WORKSPACE/.github/scripts/yocto-verify-common.sh
          yocto_test_verify "Librelp" "$OUTPUT_FILE" || exit 1

      - name: Upload ptest logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: librelp-ptest-logs-${{ matrix.wolfssl_ref }}-${{ matrix.openssl_ref }}-${{ matrix.fips_ref == 'FIPS' && 'fips' || 'nonfips' }}-${{ matrix.replace_default && 'replace-default' || 'standalone' }}
          path: |
            /tmp/librelp-ptest-output-*.txt
          retention-days: 7
          if-no-files-found: ignore
