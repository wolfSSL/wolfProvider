- name: Setup env vars
  run: |
    # These paths must match the ones in build-wolfprovider.yml
    PACKAGES_PATH=/tmp
    echo "PACKAGES_PATH=$PACKAGES_PATH" >> "$GITHUB_ENV"
    echo "WOLFSSL_PACKAGES_PATH=\${PACKAGES_PATH}/wolfssl-packages"   >> "$GITHUB_ENV"
    echo "OPENSSL_PACKAGES_PATH=\${PACKAGES_PATH}/openssl-packages"   >> "$GITHUB_ENV"
    echo "WOLFPROV_PACKAGES_PATH=\${PACKAGES_PATH}/wolfprov-packages" >> "$GITHUB_ENV"

- name: Checkout wolfProvider
  uses: actions/checkout@v4
  with:
    fetch-depth: 1

- name: Download packages from build job
  uses: actions/download-artifact@v4
  with:
    name: debian-packages-${{ matrix.fips_ref }}${{ matrix.replace_default && '-replace-default' || '' }}-${{ matrix.wolfssl_ref }}-${{ matrix.openssl_ref }}
    path: ${{ env.PACKAGES_PATH }}

- name: Install wolfSSL/OpenSSL/wolfprov packages
  run: |
    apt install --reinstall -y \
      ${{ env.WOLFSSL_PACKAGES_PATH }}/libwolfssl_*.deb

    apt install --reinstall -y --allow-downgrades --allow-change-held-packages \
      ${{ env.OPENSSL_PACKAGES_PATH }}/openssl_*.deb \
      ${{ env.OPENSSL_PACKAGES_PATH }}/libssl3_*.deb \
      ${{ env.OPENSSL_PACKAGES_PATH }}/libssl-dev_*.deb

    apt install --reinstall -y \
      ${{ env.WOLFPROV_PACKAGES_PATH }}/libwolfprov_*.deb

- name: Verify wolfProvider is properly installed
  run: |
    $GITHUB_WORKSPACE/scripts/verify-install.sh \
      ${{ matrix.replace_default && '--replace-default' || '' }} \
      ${{ matrix.fips_ref == 'FIPS' && '--fips' || '' }}
